<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Sharer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>ðŸ”´ Keystroke Sharer</header>
  <div class="container">
    <button id="createRoom">Create New Room</button>
    <div id="roomInfo" style="display:none;">
      <p>Room ID: <span id="roomId"></span></p>
      <p>Sharer Token: <span id="token"></span></p>
    </div>
    <div class="keystroke-log" id="log"></div>
  </div>

  <script>
    let ws;
    let roomId, token;

    document.getElementById("createRoom").onclick = async () => {
      const res = await fetch('/api/new-room', { method: 'POST' });
      const data = await res.json();
      roomId = data.roomId;
      token = data.token;
      document.getElementById("roomId").innerText = roomId;
      document.getElementById("token").innerText = token;
      document.getElementById("roomInfo").style.display = 'block';
      startSharer();
    };

    function startSharer() {
      ws = new WebSocket(`ws://${location.host}`);
      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'join', role: 'sharer', roomId, token }));
      };
      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'joined') {
          log(`âœ… Connected as sharer`);
          document.addEventListener("keydown", e => {
            ws.send(JSON.stringify({
              type: 'keystroke',
              key: e.key,
              code: e.code,
              ts: Date.now(),
              username: "Sharer"
            }));
            log(`Pressed: ${e.key}`);
          });
        }
      };
    }

    function log(text) {
      const div = document.getElementById("log");
      div.innerHTML += `<div>${text}</div>`;
      div.scrollTop = div.scrollHeight;
    }
  </script>
</body>
</html>
